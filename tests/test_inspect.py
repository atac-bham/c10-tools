
from click.testing import CliRunner
from termcolor import colored
import pytest

from c10_tools.inspect import inspect


def test_defaults_csv():
    result = CliRunner(mix_stderr=False).invoke(inspect, [pytest.SAMPLE], obj={'quiet': True})
    expected = 'Channel,Type,Sequence,Size,Time,Valid,Offset\n0,1,182,6680,N/A,Yes,0\n1,17,110,36,343 16:47:12.000000,Yes,6680\n3,25,204,3168,343 16:47:12.347833,Yes,6716\n10,56,102,1800,343 16:47:12.347336,Yes,9884\n13,64,196,15636,343 16:47:12.254091,Yes,11684\n14,64,196,15636,343 16:47:12.254729,Yes,27320\n18,64,195,15636,343 16:47:12.255114,Yes,42956\n16,64,195,15636,343 16:47:12.255597,Yes,58592\n20,64,195,15636,343 16:47:12.255697,Yes,74228\n19,64,195,15636,343 16:47:12.255841,Yes,89864\n15,64,195,15636,343 16:47:12.257703,Yes,105500\n17,64,195,15636,343 16:47:12.258656,Yes,121136\n2,25,245,888,343 16:47:12.358870,Yes,136772\n9,56,0,984,343 16:47:12.357617,Yes,137660\n12,48,221,14984,343 16:47:12.404215,Yes,138644\n4,25,56,2656,343 16:47:12.363605,Yes,153628\n5,25,56,2692,343 16:47:12.376674,Yes,156284\n11,56,149,2768,343 16:47:12.376256,Yes,158976\n13,64,197,15636,343 16:47:12.285300,Yes,161744\n14,64,197,15636,343 16:47:12.285937,Yes,177380\n18,64,196,15636,343 16:47:12.286322,Yes,193016\n20,64,196,15636,343 16:47:12.286905,Yes,208652\n16,64,196,15636,343 16:47:12.286806,Yes,224288\n19,64,196,15636,343 16:47:12.287049,Yes,239924\n7,56,137,2552,343 16:47:12.382035,Yes,255560\n15,64,196,15636,343 16:47:12.288912,Yes,258112\n17,64,196,15636,343 16:47:12.289864,Yes,273748\n6,56,87,2208,343 16:47:12.385877,Yes,289384\n8,56,136,2776,343 16:47:12.390974,Yes,291592\n12,48,222,12132,343 16:47:12.449700,Yes,294368\n13,64,198,15636,343 16:47:12.316508,Yes,306500\n14,64,198,15636,343 16:47:12.317145,Yes,322136\n18,64,197,15636,343 16:47:12.317530,Yes,337772\n16,64,197,15636,343 16:47:12.318014,Yes,353408\n20,64,197,15636,343 16:47:12.318113,Yes,369044\n19,64,197,15636,343 16:47:12.318257,Yes,384680\n3,25,205,3112,343 16:47:12.425016,Yes,400316\n15,64,197,15636,343 16:47:12.320120,Yes,403428\n17,64,197,15636,343 16:47:12.321073,Yes,419064\n10,56,103,1864,343 16:47:12.433515,Yes,434700\n13,64,199,15636,343 16:47:12.347716,Yes,436564\n14,64,199,15636,343 16:47:12.348354,Yes,452200\n18,64,198,15636,343 16:47:12.348738,Yes,467836\n16,64,198,15636,343 16:47:12.349222,Yes,483472\n20,64,198,15636,343 16:47:12.349321,Yes,499108\n19,64,198,15636,343 16:47:12.349465,Yes,514744\n9,56,1,968,343 16:47:12.443606,Yes,530380\n15,64,198,15636,343 16:47:12.351328,Yes,531348\n2,25,246,1244,343 16:47:12.452759,Yes,546984\n17,64,198,15636,343 16:47:12.352281,Yes,548228\n12,48,223,15028,343 16:47:12.500015,Yes,563864\n4,25,57,2608,343 16:47:12.460163,Yes,578892\n11,56,150,2664,343 16:47:12.462606,Yes,581500\n5,25,57,2984,343 16:47:12.464329,Yes,584164\n7,56,138,2632,343 16:47:12.468076,Yes,587148\n13,64,200,15636,343 16:47:12.378924,Yes,589780\n6,56,88,2264,343 16:47:12.472613,Yes,605416\n14,64,200,15636,343 16:47:12.379562,Yes,607680\n18,64,199,15636,343 16:47:12.379946,Yes,623316\n16,64,199,15636,343 16:47:12.380430,Yes,638952\n20,64,199,15636,343 16:47:12.380530,Yes,654588\n19,64,199,15636,343 16:47:12.380674,Yes,670224\n15,64,199,15636,343 16:47:12.382536,Yes,685860\n8,56,137,2776,343 16:47:12.476986,Yes,701496\n17,64,199,15636,343 16:47:12.383489,Yes,704272\n3,25,206,3144,343 16:47:12.500391,Yes,719908\n12,48,224,14884,343 16:47:12.540955,Yes,723052\n13,64,201,15636,343 16:47:12.410132,Yes,737936\n14,64,201,15636,343 16:47:12.410770,Yes,753572\n18,64,200,15636,343 16:47:12.411154,Yes,769208\n16,64,200,15636,343 16:47:12.411638,Yes,784844\n19,64,200,15636,343 16:47:12.411882,Yes,800480\n20,64,200,15636,343 16:47:12.411738,Yes,816116\n15,64,200,15636,343 16:47:12.413745,Yes,831752\n17,64,200,15636,343 16:47:12.414697,Yes,847388\n12,48,225,3184,343 16:47:12.592056,Yes,863024\n10,56,104,1912,343 16:47:12.520307,Yes,866208\n9,56,2,1168,343 16:47:12.531728,Yes,868120\n13,64,202,15636,343 16:47:12.441341,Yes,869288\n14,64,202,15636,343 16:47:12.441978,Yes,884924\n2,25,247,872,343 16:47:12.546774,Yes,900560\n18,64,201,15636,343 16:47:12.442362,Yes,901432\n16,64,201,15636,343 16:47:12.442847,Yes,917068\n20,64,201,15636,343 16:47:12.442946,Yes,932704\n19,64,201,15636,343 16:47:12.443090,Yes,948340\n15,64,201,15636,343 16:47:12.444953,Yes,963976\n17,64,201,15636,343 16:47:12.445905,Yes,979612\n4,25,58,2692,343 16:47:12.547925,Yes,995248\n11,56,151,2688,343 16:47:12.548646,Yes,997940\n7,56,139,2504,343 16:47:12.555153,Yes,1000628\n5,25,58,2888,343 16:47:12.553403,Yes,1003132\n6,56,89,2192,343 16:47:12.558660,Yes,1006020\n8,56,138,2744,343 16:47:12.563030,Yes,1008212\n12,48,226,14928,343 16:47:12.604234,Yes,1010956\n13,64,203,15636,343 16:47:12.472549,Yes,1025884\n'
    assert expected in result.stdout


def test_defaults_ascii():
    result = CliRunner(mix_stderr=True).invoke(inspect, [pytest.SAMPLE], obj={'quiet': True})
    expected = '''\
-----------------------------------------------------------------------------------------------
| Channel | Type | Sequence | Size    | Time                        | Valid | Offset          |
-----------------------------------------------------------------------------------------------
|       0 |    1 |      182 |   6,680 | N/A                         | Yes   |               0 |
|       1 |   17 |      110 |      36 | 343 16:47:12.000000         | Yes   |           6,680 |
|       3 |   25 |      204 |   3,168 | 343 16:47:12.347833         | Yes   |           6,716 |
|      10 |   56 |      102 |   1,800 | 343 16:47:12.347336         | Yes   |           9,884 |
|      13 |   64 |      196 |  15,636 | 343 16:47:12.254091         | Yes   |          11,684 |'''
    assert expected in result.stdout


def test_error_csv():
    result = CliRunner(mix_stderr=False).invoke(inspect, [pytest.BAD, '-c', '1'], obj={'quiet': True})
    assert result.stdout == '''Channel,Type,Sequence,Size,Time,Valid,Offset
1,17,110,36,343 16:47:12.000000,Yes,0
"Type 0x5 not implemented at 36"
'''


def test_error_ascii():
    result = CliRunner(mix_stderr=True).invoke(inspect, [pytest.BAD], obj={'quiet': True})
    expected = '''\
-----------------------------------------------------------------------------------------------
| Channel | Type | Sequence | Size    | Time                        | Valid | Offset          |
-----------------------------------------------------------------------------------------------
|       0 |    1 |      182 |   6,680 | N/A                         | Yes   |               0 |
|       1 |   17 |      110 |      36 | 343 16:47:12.000000         | Yes   |           6,680 |
{}
|      14 |   64 |      196 |  15,636 | 343 16:47:12.254729         | Yes   |          24,182 |
|      18 |   64 |      195 |  15,636 | 343 16:47:12.255114         | Yes   |          39,818 |'''.format(
    colored('Packet length incorrect at 6,716', 'red'))
    assert expected in result.stdout


@pytest.mark.parametrize('type,expected', (
    (1, 2),
    (17, 2),
    (25, 13),
    (48, 7),
    (56, 19),
    (64, 58),
))
def test_inspect_filtering(type, expected):
    result = CliRunner(mix_stderr=True).invoke(inspect, [pytest.SAMPLE, '-t', type],
                                               obj={'quiet': True})
    assert len(result.stdout.splitlines()) == (expected + 3)
